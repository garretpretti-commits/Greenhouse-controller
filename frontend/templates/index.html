<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenhouse Monitor</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Inline test script to verify data is loading
        function updateData() {
            console.log('Fetching data...');
            fetch('/api/sensors/current')
                .then(response => response.json())
                .then(data => {
                    console.log('Data received:', data);
                    // Update temperature
                    if (data.temperature !== null && data.temperature !== undefined) {
                        const tempF = (data.temperature * 9/5 + 32).toFixed(1);
                        document.getElementById('tempValue').textContent = tempF + '¬∞';
                        document.getElementById('tempCelsius').textContent = data.temperature.toFixed(1) + '¬∞C';
                        
                        // Update last updated time
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', second: '2-digit'});
                        document.getElementById('tempLastUpdated').textContent = 'Updated: ' + timeStr;
                    } else {
                        document.getElementById('tempValue').textContent = '--';
                        document.getElementById('tempCelsius').textContent = '--';
                    }
                    // Update humidity
                    if (data.humidity !== null && data.humidity !== undefined) {
                        document.getElementById('humidityValue').textContent = data.humidity.toFixed(0) + '%';
                    } else {
                        document.getElementById('humidityValue').textContent = '--';
                    }
                    
                    // Update soil moisture with disconnected sensor detection
                    if (data.soil_moisture) {
                        for (let i = 1; i <= 4; i++) {
                            const soilValue = data.soil_moisture['soil' + i];
                            if (soilValue !== undefined) {
                                const elem = document.getElementById('soil' + i + 'Value');
                                if (elem) {
                                    // Detect likely disconnected sensor (reads very low or very high)
                                    if (soilValue <= 2 || soilValue >= 95) {
                                        elem.textContent = '‚Äî';
                                        elem.title = 'Sensor disconnected';
                                        elem.style.opacity = '0.4';
                                    } else {
                                        elem.textContent = soilValue.toFixed(1) + '%';
                                        elem.title = '';
                                        elem.style.opacity = '1';
                                    }
                                }
                            }
                        }
                    }
                    
                    // Update target displays
                    fetch('/api/climate/settings')
                        .then(r => r.json())
                        .then(settings => {
                            if (settings && !settings.error) {
                                const targetHumidityDisplay = document.getElementById('targetHumidityDisplay');
                                const targetTempDisplay = document.getElementById('targetTempDisplay');
                                if (targetHumidityDisplay) {
                                    targetHumidityDisplay.textContent = settings.target_humidity + '%';
                                }
                                if (targetTempDisplay) {
                                    const targetTempF = (settings.target_temp * 9/5 + 32).toFixed(0);
                                    targetTempDisplay.textContent = targetTempF + '¬∞F';
                                }
                            }
                        });
                })
                .catch(error => console.error('Error:', error));
        }
        
        function updateStatistics() {
            fetch('/api/sensors/history?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        // Calculate statistics
                        const temps = data.map(d => d.temperature);
                        const humidities = data.map(d => d.humidity);
                        
                        const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length * 9/5 + 32).toFixed(0);
                        const minTemp = (Math.min(...temps) * 9/5 + 32).toFixed(0);
                        const maxTemp = (Math.max(...temps) * 9/5 + 32).toFixed(0);
                        const avgHumidity = (humidities.reduce((a, b) => a + b, 0) / humidities.length).toFixed(0);
                        const minHumidity = Math.min(...humidities).toFixed(0);
                        const maxHumidity = Math.max(...humidities).toFixed(0);
                        
                        // Update stat boxes
                        const statBoxes = document.querySelectorAll('.stat-box .stat-value');
                        if (statBoxes.length >= 6) {
                            statBoxes[0].textContent = avgTemp + '¬∞';
                            statBoxes[1].textContent = minTemp + '¬∞';
                            statBoxes[2].textContent = maxTemp + '¬∞';
                            statBoxes[3].textContent = avgHumidity + '%';
                            statBoxes[4].textContent = minHumidity + '%';
                            statBoxes[5].textContent = maxHumidity + '%';
                        }
                    }
                })
                .catch(error => console.error('Stats error:', error));
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit'
            });
            const elem = document.getElementById('currentTime');
            if (elem) elem.textContent = timeStr;
        }
        
        function updateChart() {
            fetch('/api/sensors/history?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const canvas = document.getElementById('historyChart');
                        if (canvas && typeof Chart !== 'undefined') {
                            const ctx = canvas.getContext('2d');
                            
                            // Prepare data
                            const labels = data.map(d => {
                                const date = new Date(d.timestamp * 1000);
                                return date.toLocaleTimeString('en-US', {hour: 'numeric'});
                            });
                            const temps = data.map(d => d.temperature * 9/5 + 32);
                            const humidities = data.map(d => d.humidity);
                            
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Temperature (¬∞F)',
                                        data: temps,
                                        borderColor: 'rgb(237, 125, 49)',
                                        backgroundColor: 'rgba(237, 125, 49, 0.1)',
                                        yAxisID: 'y',
                                    }, {
                                        label: 'Humidity (%)',
                                        data: humidities,
                                        borderColor: 'rgb(91, 155, 213)',
                                        backgroundColor: 'rgba(91, 155, 213, 0.1)',
                                        yAxisID: 'y1',
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    interaction: {
                                        mode: 'index',
                                        intersect: false,
                                    },
                                    scales: {
                                        y: {
                                            type: 'linear',
                                            display: true,
                                            position: 'left',
                                            title: {
                                                display: true,
                                                text: 'Temperature (¬∞F)'
                                            }
                                        },
                                        y1: {
                                            type: 'linear',
                                            display: true,
                                            position: 'right',
                                            title: {
                                                display: true,
                                                text: 'Humidity (%)'
                                            },
                                            grid: {
                                                drawOnChartArea: false,
                                            },
                                        },
                                    }
                                }
                            });
                        }
                    }
                })
                .catch(error => console.error('Chart error:', error));
        }
        
        function updateSoilChart() {
            fetch('/api/sensors/history?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const canvas = document.getElementById('soilChart');
                        if (!canvas) {
                            // Create canvas if it doesn't exist
                            const container = document.getElementById('soilChartContainer');
                            if (container) {
                                container.innerHTML = '<canvas id="soilChart"></canvas>';
                            }
                            return updateSoilChart(); // Retry after creating canvas
                        }
                        
                        if (typeof Chart !== 'undefined') {
                            const ctx = canvas.getContext('2d');
                            
                            // Prepare data
                            const labels = data.map(d => {
                                const date = new Date(d.timestamp * 1000);
                                return date.toLocaleTimeString('en-US', {hour: 'numeric'});
                            });
                            const soil1 = data.map(d => d.soil1 || null);
                            const soil2 = data.map(d => d.soil2 || null);
                            const soil3 = data.map(d => d.soil3 || null);
                            const soil4 = data.map(d => d.soil4 || null);
                            
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Soil 1 (%)',
                                        data: soil1,
                                        borderColor: 'rgb(139, 195, 74)',
                                        backgroundColor: 'rgba(139, 195, 74, 0.1)',
                                        borderWidth: 2,
                                        spanGaps: true
                                    }, {
                                        label: 'Soil 2 (%)',
                                        data: soil2,
                                        borderColor: 'rgb(76, 175, 80)',
                                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                        borderWidth: 2,
                                        spanGaps: true
                                    }, {
                                        label: 'Soil 3 (%)',
                                        data: soil3,
                                        borderColor: 'rgb(46, 125, 50)',
                                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                                        borderWidth: 2,
                                        spanGaps: true
                                    }, {
                                        label: 'Soil 4 (%)',
                                        data: soil4,
                                        borderColor: 'rgb(27, 94, 32)',
                                        backgroundColor: 'rgba(27, 94, 32, 0.1)',
                                        borderWidth: 2,
                                        spanGaps: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    interaction: {
                                        mode: 'index',
                                        intersect: false,
                                    },
                                    scales: {
                                        y: {
                                            type: 'linear',
                                            display: true,
                                            title: {
                                                display: true,
                                                text: 'Moisture (%)'
                                            },
                                            min: 0,
                                            max: 100
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: true,
                                            position: 'top'
                                        }
                                    }
                                }
                            });
                        }
                    }
                })
                .catch(error => console.error('Soil chart error:', error));
        }
        
        function updateRelayStatus() {
            fetch('/api/relays')
                .then(response => response.json())
                .then(data => {
                    if (data && !data.error) {
                        const states = data.states || data;
                        const messages = data.messages || {};
                        
                        // Humidifier
                        const humidifierOn = states.humidifier;
                        document.getElementById('humidifierStatus').textContent = humidifierOn ? 'ON' : 'OFF';
                        document.getElementById('humidifierStatus').className = 'relay-status ' + (humidifierOn ? 'status-on' : 'status-off');
                        document.getElementById('humidifierMessage').textContent = messages.humidifier || '';
                        
                        // Dehumidifier
                        const dehumidifierOn = states.dehumidifier;
                        document.getElementById('dehumidifierStatus').textContent = dehumidifierOn ? 'ON' : 'OFF';
                        document.getElementById('dehumidifierStatus').className = 'relay-status ' + (dehumidifierOn ? 'status-on' : 'status-off');
                        document.getElementById('dehumidifierMessage').textContent = messages.dehumidifier || '';
                        
                        // Heater
                        const heaterOn = states.heater;
                        document.getElementById('heaterStatus').textContent = heaterOn ? 'ON' : 'OFF';
                        document.getElementById('heaterStatus').className = 'relay-status ' + (heaterOn ? 'status-on' : 'status-off');
                        document.getElementById('heaterMessage').textContent = messages.heater || '';
                        
                        // Light
                        const lightOn = states.light;
                        document.getElementById('lightStatus').textContent = lightOn ? 'ON' : 'OFF';
                        document.getElementById('lightStatus').className = 'relay-status ' + (lightOn ? 'status-on' : 'status-off');
                        document.getElementById('lightMessage').textContent = messages.light || '';
                    }
                })
                .catch(error => console.error('Error loading relay status:', error));
        }
        
        function updateLightSchedule() {
            fetch('/api/light/schedule')
                .then(response => response.json())
                .then(data => {
                    if (data && data.on_time && data.off_time) {
                        document.getElementById('scheduleOnTime').textContent = data.on_time;
                        document.getElementById('scheduleOffTime').textContent = data.off_time;
                        document.getElementById('currentSchedule').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error loading light schedule:', error));
        }
        
        function setLightSchedule() {
            const cycle = document.getElementById('lightCycle').value;
            const offTime = document.getElementById('lightOffTime').value;
            
            if (!offTime) {
                alert('Please enter when lights turn off');
                return;
            }
            
            // Parse the cycle (e.g., "18/6" means 18 hours on, 6 hours off)
            const [hoursOn, hoursOff] = cycle.split('/').map(Number);
            
            // Calculate on time based on off time and hours on
            const [offHour, offMinute] = offTime.split(':').map(Number);
            let onHour = offHour - hoursOn;
            
            // Handle day wrap-around
            if (onHour < 0) {
                onHour += 24;
            }
            
            const onTime = `${String(onHour).padStart(2, '0')}:${String(offMinute).padStart(2, '0')}`;
            
            console.log(`Setting schedule: ${cycle} - Lights on at ${onTime}, off at ${offTime}`);
            
            fetch('/api/light/schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    on_time: onTime,
                    off_time: offTime,
                    enabled: true
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    updateLightSchedule();
                    alert(`Light schedule set to ${cycle}: ON at ${onTime}, OFF at ${offTime}`);
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting light schedule');
            });
        }
        
        function setTargetHumidity() {
            const humidity = parseFloat(document.getElementById('newTargetHumidity').value);
            
            if (!humidity || humidity < 0 || humidity > 100) {
                alert('Please enter a valid humidity (0-100%)');
                return;
            }
            
            fetch('/api/climate/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_humidity: humidity
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('targetHumidityDisplay').textContent = humidity + '%';
                    document.getElementById('newTargetHumidity').value = '';
                    alert('Target humidity updated to ' + humidity + '%');
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting target humidity');
            });
        }
        
        function restartController() {
            if (!confirm('Restart the greenhouse controller? This will disconnect sensors briefly.')) {
                return;
            }
            
            fetch('/api/system/restart', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Controller restarting... The page will refresh in 10 seconds.');
                    setTimeout(() => {
                        location.reload();
                    }, 10000);
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error restarting controller');
            });
        }

        // Temperature Schedule Functions
        let tempPeriodCount = 0;

        function loadTempSchedule() {
            fetch('/api/temp/schedule')
                .then(response => response.json())
                .then(data => {
                    const enabled = data.enabled || false;
                    document.getElementById('tempScheduleEnabled').checked = enabled;
                    
                    const periods = data.periods || [];
                    const container = document.getElementById('tempSchedulePeriods');
                    container.innerHTML = '';
                    tempPeriodCount = 0;
                    
                    if (periods.length > 0) {
                        periods.forEach(period => {
                            // Convert C to F for display
                            const tempF = Math.round(period.temperature * 9/5 + 32);
                            addTempPeriod(period.time, tempF);
                        });
                    } else {
                        // Add one default period (75¬∞F)
                        addTempPeriod('06:00', 75);
                    }
                })
                .catch(error => console.error('Error loading temp schedule:', error));
        }

        function addTempPeriod(time = '', temp = '') {
            if (tempPeriodCount >= 4) {
                alert('Maximum 4 periods allowed');
                return;
            }
            
            const container = document.getElementById('tempSchedulePeriods');
            const periodDiv = document.createElement('div');
            periodDiv.className = 'schedule-row';
            periodDiv.style.display = 'flex';
            periodDiv.style.gap = '10px';
            periodDiv.style.alignItems = 'center';
            periodDiv.style.marginBottom = '10px';
            periodDiv.innerHTML = `
                <label>Time:</label>
                <input type="time" class="time-input temp-time" value="${time}" style="width: 120px;">
                <label>Temp:</label>
                <input type="number" class="inline-input temp-value" value="${temp}" step="1" min="50" max="95" style="width: 80px;">
                <span>¬∞F</span>
                <button class="btn btn-small btn-danger" onclick="this.parentElement.remove(); tempPeriodCount--;">Remove</button>
            `;
            container.appendChild(periodDiv);
            tempPeriodCount++;
        }

        function saveTempSchedule() {
            const enabled = document.getElementById('tempScheduleEnabled').checked;
            const timeInputs = document.querySelectorAll('.temp-time');
            const tempInputs = document.querySelectorAll('.temp-value');
            
            const periods = [];
            for (let i = 0; i < timeInputs.length; i++) {
                const time = timeInputs[i].value;
                const tempF = parseFloat(tempInputs[i].value);
                
                if (!time || isNaN(tempF)) {
                    alert('Please fill in all time and temperature values');
                    return;
                }
                
                // Convert F to C for the API
                const tempC = (tempF - 32) * 5/9;
                
                periods.push({
                    time: time,
                    temperature: tempC
                });
            }
            
            if (periods.length === 0) {
                alert('Please add at least one temperature period');
                return;
            }
            
            fetch('/api/temp/schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    enabled: enabled,
                    periods: periods
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Temperature schedule saved!');
                    loadTempSchedule();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving temperature schedule');
            });
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            updateData();
            updateStatistics();
            updateChart();
            updateSoilChart();
            loadPlants();
            updateRelayStatus();
            updateLightSchedule();
            updateCurrentTime();
            // Update every 5 seconds
            setInterval(updateData, 5000);
            setInterval(updateRelayStatus, 5000);
            // Update current time every second
            setInterval(updateCurrentTime, 1000);
            // Update stats and chart every 2 minutes
            setInterval(updateStatistics, 120000);
            
            // Plant form submission
            document.getElementById('addPlantBtn').addEventListener('click', addPlant);
            document.getElementById('clearPlantBtn').addEventListener('click', clearPlantForm);
            
            // Light schedule button
            document.getElementById('setScheduleBtn').addEventListener('click', setLightSchedule);
            
            // Temperature schedule buttons
            document.getElementById('addPeriodBtn').addEventListener('click', addTempPeriod);
            document.getElementById('saveTempScheduleBtn').addEventListener('click', saveTempSchedule);
            loadTempSchedule();
            
            // Climate control buttons
            document.getElementById('setHumidityBtn').addEventListener('click', setTargetHumidity);
            
            // System control button
            document.getElementById('restartControllerBtn').addEventListener('click', restartController);
        });
        
        function loadPlants() {
            console.log('Loading plants...');
            fetch('/api/plants')
                .then(response => response.json())
                .then(plants => {
                    console.log('Plants loaded:', plants);
                    const plantList = document.getElementById('plantList');
                    if (!plantList) {
                        console.error('plantList element not found!');
                        return;
                    }
                    if (plants && plants.length > 0) {
                        plantList.innerHTML = plants.map(plant => {
                            // Calculate days since veg and flower start
                            let vegDays = '';
                            let flowerDays = '';
                            const now = new Date();
                            
                            if (plant.veg_start_date) {
                                const vegStart = new Date(plant.veg_start_date);
                                // If flowering, calculate veg days up to flower start, otherwise to now
                                const vegEnd = plant.flower_start_date ? new Date(plant.flower_start_date) : now;
                                const days = Math.floor((vegEnd - vegStart) / (1000 * 60 * 60 * 24));
                                vegDays = `<br>Veg: ${days} days`;
                            }
                            
                            if (plant.flower_start_date) {
                                const flowerStart = new Date(plant.flower_start_date);
                                const days = Math.floor((now - flowerStart) / (1000 * 60 * 60 * 24));
                                flowerDays = ` | Flower: ${days} days`;
                            }
                            
                            return `
                            <div class="plant-item">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${plant.strain_name}</strong> (${plant.plant_type})
                                        ${vegDays}
                                        ${flowerDays}
                                        ${plant.dry_weight ? `<br>Yield: ${plant.dry_weight} lbs` : ''}
                                        ${plant.notes ? `<br><small>${plant.notes}</small>` : ''}
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="window.deletePlant(${plant.id})">Delete</button>
                                </div>
                            </div>
                            `;
                        }).join('');
                    } else {
                        plantList.innerHTML = '<p>No plants added yet</p>';
                    }
                })
                .catch(error => console.error('Error loading plants:', error));
        }
        
        function addPlant() {
            const data = {
                strain_name: document.getElementById('strainName').value,
                plant_type: document.getElementById('plantType').value,
                veg_start_date: document.getElementById('vegStartDate').value,
                flower_start_date: document.getElementById('flowerStartDate').value,
                harvest_date: document.getElementById('harvestDate').value,
                dry_weight: parseFloat(document.getElementById('dryWeight').value) || null,
                notes: document.getElementById('plantNotes').value
            };
            
            if (!data.strain_name || !data.plant_type) {
                alert('Please enter strain name and type');
                return;
            }
            
            fetch('/api/plants', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Plant added successfully!');
                    clearPlantForm();
                    loadPlants();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding plant');
            });
        }
        
        function clearPlantForm() {
            document.getElementById('strainName').value = '';
            document.getElementById('plantType').value = '';
            document.getElementById('vegStartDate').value = '';
            document.getElementById('flowerStartDate').value = '';
            document.getElementById('harvestDate').value = '';
            document.getElementById('dryWeight').value = '';
            document.getElementById('plantNotes').value = '';
        }
        
        function deletePlant(plantId) {
            console.log('deletePlant called with ID:', plantId);
            if (!confirm('Are you sure you want to delete this plant?')) {
                return;
            }
            
            console.log('Sending archive request for plant:', plantId);
            fetch(`/api/plants/${plantId}/archive`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                console.log('Archive result:', result);
                if (result.success) {
                    loadPlants();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting plant');
            });
        }
        
        // Make deletePlant globally accessible
        window.deletePlant = deletePlant;
    </script>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div id="currentTime" style="font-size: 0.9em; color: white; margin-bottom: 5px; margin-left: -20px;"></div>
                    <h1>üå± Greenhouse Monitor</h1>
                    <div class="subtitle">Real-time environmental monitoring</div>
                </div>
                <button class="btn btn-small btn-orange" id="restartControllerBtn" style="font-size: 0.8em; padding: 8px 12px;">üîÑ Restart</button>
            </div>
        </header>

        <!-- Temperature and Humidity Cards -->
        <section class="readings-grid">
            <div class="card reading-card">
                <div class="card-header">
                    <h2>üå°Ô∏è Temperature</h2>
                    <div id="tempLastUpdated" style="font-size: 0.75em; color: #888;"></div>
                </div>
                <div class="card-body">
                    <div class="large-value">
                        <span id="tempValue">--</span>
                    </div>
                    <div class="value-unit">FAHRENHEIT</div>
                    <div class="value-secondary" id="tempCelsius">--</div>
                </div>
            </div>

            <div class="card reading-card">
                <div class="card-header">
                    <h2>üíß Humidity</h2>
                </div>
                <div class="card-body">
                    <div class="large-value">
                        <span id="humidityValue">--</span>
                    </div>
                    <div class="value-unit">PERCENT</div>
                    <div class="value-secondary">--</div>
                </div>
            </div>
        </section>

        <!-- Plant Tracker Section -->
        <section class="card">
            <div class="card-header clickable" onclick="toggleSection('plantTracker')">
                <h2>üåø Plant Tracker</h2>
                <span class="expand-icon" id="plantTrackerIcon">‚ñº</span>
            </div>
            <div class="card-body" id="plantTrackerContent">
                <div class="section-header clickable" onclick="toggleSubSection('addPlant')">
                    <div class="section-title">‚ûï Add New Plant</div>
                    <span class="expand-icon" id="addPlantIcon">‚ñº</span>
                </div>
                <div class="sub-section collapsed" id="addPlantContent">
                    <div class="form-group">
                        <label>Strain Name *</label>
                        <input type="text" id="strainName" class="form-input" placeholder="e.g., Blue Dream">
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="plantType" class="form-input">
                            <option value="">-- Select Type --</option>
                            <option value="Indica">Indica</option>
                            <option value="Sativa">Sativa</option>
                            <option value="Hybrid">Hybrid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Veg Start Date</label>
                        <input type="date" id="vegStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Flower Start Date</label>
                        <input type="date" id="flowerStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Harvest Date</label>
                        <input type="date" id="harvestDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Dry Weight (lbs)</label>
                        <input type="number" id="dryWeight" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="plantNotes" class="form-input" rows="3" placeholder="Add any notes about this plant..."></textarea>
                    </div>
                    <div class="button-group">
                        <button id="addPlantBtn" class="btn btn-primary">Add Plant</button>
                        <button id="clearPlantBtn" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
                
                <!-- Plant List -->
                <div style="margin-top: 20px;">
                    <h3>Your Plants</h3>
                    <div id="plantList"></div>
                </div>
            </div>
        </section>

        <!-- System Status Section -->
        <section class="card">
            <div class="card-header">
                <h2>‚öôÔ∏è System Status</h2>
            </div>
            <div class="card-body">
                <div class="relay-list">
                    <div class="relay-item">
                        <div>
                            <strong>Humidifier</strong>
                            <div class="relay-message" id="humidifierMessage">--</div>
                        </div>
                        <span class="relay-status" id="humidifierStatus">--</span>
                    </div>
                    <div class="relay-item">
                        <div>
                            <strong>Dehumidifier</strong>
                            <div class="relay-message" id="dehumidifierMessage">--</div>
                        </div>
                        <span class="relay-status" id="dehumidifierStatus">--</span>
                    </div>
                    <div class="relay-item">
                        <div>
                            <strong>Heater</strong>
                            <div class="relay-message" id="heaterMessage">--</div>
                        </div>
                        <span class="relay-status" id="heaterStatus">--</span>
                    </div>
                    <div class="relay-item">
                        <div>
                            <strong>Light</strong>
                            <div class="relay-message" id="lightMessage">--</div>
                        </div>
                        <span class="relay-status" id="lightStatus">--</span>
                    </div>
                </div>

                <div class="target-settings">
                    <div class="target-row">
                        <span class="target-label">Target Humidity: <strong id="targetHumidityDisplay">--%</strong></span>
                    </div>
                    <div class="target-input-group">
                        <label>New Target:</label>
                        <input type="number" class="inline-input" id="newTargetHumidity" placeholder="">
                        <span>%</span>
                        <button class="btn btn-small btn-primary" id="setHumidityBtn">Set</button>
                    </div>

                    <div class="target-row" style="margin-top: 20px;">
                        <span class="target-label">Current Target Temp: <strong id="targetTempDisplay">--¬∞F</strong></span>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Use Temperature Schedule below to set targets</div>
                    </div>
                </div>

                <!-- Light Schedule -->
                <div class="schedule-section">
                    <h3>üí° Light Schedule</h3>
                    <div class="schedule-display" id="currentSchedule" style="padding: 10px; background: rgba(255,255,255,0.3); border-radius: 6px; margin-bottom: 15px; display: none;">
                        <strong>Active Schedule:</strong><br>
                        <span id="scheduleOnTime">--</span> to <span id="scheduleOffTime">--</span>
                    </div>
                    <div class="schedule-inputs">
                        <div class="schedule-row">
                            <label>Light Cycle:</label>
                            <select class="time-input" id="lightCycle" style="width: auto;">
                                <option value="18/6">18/6 (Veg)</option>
                                <option value="16/8">16/8</option>
                                <option value="14/10">14/10</option>
                                <option value="12/12">12/12 (Flower)</option>
                                <option value="20/4">20/4 (Auto)</option>
                                <option value="24/0">24/0 (Seedling)</option>
                            </select>
                        </div>
                        <div class="schedule-row">
                            <label>Lights Off At:</label>
                            <input type="time" class="time-input" id="lightOffTime" placeholder="">
                        </div>
                        <button class="btn btn-yellow" id="setScheduleBtn">Set Schedule</button>
                    </div>
                </div>

                <!-- Temperature Schedule -->
                <div class="schedule-section" style="margin-top: 30px;">
                    <h3>üå°Ô∏è Temperature Schedule</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="tempScheduleEnabled" style="width: auto;">
                            <span>Enable Dynamic Temperature Schedule</span>
                        </label>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Set up to 4 temperature periods throughout the day</div>
                    </div>
                    <div id="tempSchedulePeriods">
                        <!-- Periods will be added here dynamically -->
                    </div>
                    <button class="btn btn-secondary" id="addPeriodBtn" style="margin-top: 10px;">+ Add Period</button>
                    <button class="btn btn-orange" id="saveTempScheduleBtn" style="margin-top: 10px;">Save Temperature Schedule</button>
                </div>
            </div>
        </section>

        <!-- Soil Moisture & Watering -->
        <section class="card">
            <div class="card-header">
                <h2>üåßÔ∏è Soil Moisture & Watering</h2>
                <button class="btn btn-refresh" onclick="refreshSoil()">Refresh</button>
            </div>
            <div class="card-body">
                <!-- Current Soil Moisture Readings -->
                <div class="readings-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); margin-bottom: 20px;">
                    <div style="padding: 15px; background: rgba(255,255,255,0.3); border-radius: 6px; text-align: center;">
                        <div style="font-size: 0.9em; margin-bottom: 5px;">üå± Soil 1</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: var(--primary-green);" id="soil1Value">--</div>
                    </div>
                    <div style="padding: 15px; background: rgba(255,255,255,0.3); border-radius: 6px; text-align: center;">
                        <div style="font-size: 0.9em; margin-bottom: 5px;">üå± Soil 2</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: var(--primary-green);" id="soil2Value">--</div>
                    </div>
                    <div style="padding: 15px; background: rgba(255,255,255,0.3); border-radius: 6px; text-align: center;">
                        <div style="font-size: 0.9em; margin-bottom: 5px;">üå± Soil 3</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: var(--primary-green);" id="soil3Value">--</div>
                    </div>
                    <div style="padding: 15px; background: rgba(255,255,255,0.3); border-radius: 6px; text-align: center;">
                        <div style="font-size: 0.9em; margin-bottom: 5px;">üå± Soil 4</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: var(--primary-green);" id="soil4Value">--</div>
                    </div>
                </div>
                
                <h3>Moisture History (All Sensors)</h3>
                <div class="chart-container" id="soilChartContainer"></div>
                
                <!-- Watering Controls -->
                <div class="section-header clickable" onclick="toggleSubSection('wateringControls')">
                    <div class="section-title">Watering Controls</div>
                    <span class="expand-icon" id="wateringControlsIcon">‚ñº</span>
                </div>
                <div class="sub-section collapsed" id="wateringControlsContent">
                    <h4>Set Threshold</h4>
                    <div class="form-group">
                        <label>Sensor</label>
                        <select class="form-input">
                            <option>Sensor 1</option>
                            <option>Sensor 2</option>
                            <option>Sensor 3</option>
                            <option>Sensor 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Min Moisture</label>
                        <input type="number" class="form-input" placeholder="e.g., 30">
                    </div>
                    <div class="form-group">
                        <label>Link to Plant</label>
                        <select class="form-input">
                            <option>Select plant...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary">Save Target</button>

                    <h4 style="margin-top: 30px;">Manual Watering</h4>
                    <div class="form-group">
                        <label>Sensor</label>
                        <select class="form-input">
                            <option>Sensor 1</option>
                            <option>Sensor 2</option>
                            <option>Sensor 3</option>
                            <option>Sensor 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (sec)</label>
                        <input type="number" class="form-input" placeholder="e.g., 10">
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <input type="text" class="form-input" placeholder="Optional details">
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary">Trigger</button>
                        <button class="btn btn-primary">Recommend Time</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Flow Meters -->
        <section class="card">
            <div class="card-header">
                <h2>üö∞ Flow Meters</h2>
            </div>
            <div class="card-body">
                <div>Loading meters...</div>
            </div>
        </section>

        <!-- Historical Data -->
        <section class="card">
            <div class="card-header">
                <h2>üìà Historical Data (48h)</h2>
            </div>
            <div class="card-body chart-body">
                <canvas id="historyChart"></canvas>
            </div>
        </section>

        <!-- 24h Statistics -->
        <section class="card">
            <div class="card-header">
                <h2>üìä 24h Statistics</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Avg Temp (¬∞F)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Min Temp (¬∞F)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Max Temp (¬∞F)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Avg Humidity</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Min Humidity</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Max Humidity</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Camera -->
        <section class="card">
            <div class="card-header">
                <h2>üì∑ Live Camera</h2>
            </div>
            <div class="card-body">
                <div class="camera-placeholder">
                    <p>Stream unavailable</p>
                    <div class="camera-icon">‚ñ∂Ô∏è</div>
                </div>
            </div>
        </section>
    </div>

    <script src="/static/js/dashboard.js?v=2"></script>
    <script>
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function toggleSubSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = '‚ñ≤';
            } else {
                content.classList.add('collapsed');
                icon.textContent = '‚ñº';
            }
        }

        function refreshSoil() {
            document.getElementById('soilLoading').textContent = 'Refreshing...';
            setTimeout(() => {
                document.getElementById('soilLoading').textContent = 'Loading moisture sensors...';
            }, 1000);
        }
    </script>
</body>
</html>
