<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenhouse Monitor</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Inline test script to verify data is loading
        function updateData() {
            console.log('Fetching data...');
            fetch('/api/sensors/current')
                .then(response => response.json())
                .then(data => {
                    console.log('Data received:', data);
                    // Update temperature
                    const tempF = (data.temperature * 9/5 + 32).toFixed(0);
                    document.getElementById('tempValue').textContent = tempF + '¬∞';
                    document.getElementById('tempCelsius').textContent = data.temperature.toFixed(1) + '¬∞C';
                    // Update humidity
                    document.getElementById('humidityValue').textContent = data.humidity.toFixed(0) + '%';
                    
                    // Update target displays
                    fetch('/api/climate/settings')
                        .then(r => r.json())
                        .then(settings => {
                            if (settings && !settings.error) {
                                const targetHumidityDisplay = document.getElementById('targetHumidityDisplay');
                                const targetTempDisplay = document.getElementById('targetTempDisplay');
                                if (targetHumidityDisplay) {
                                    targetHumidityDisplay.textContent = settings.target_humidity + '%';
                                }
                                if (targetTempDisplay) {
                                    const targetTempF = (settings.target_temp * 9/5 + 32).toFixed(0);
                                    targetTempDisplay.textContent = targetTempF + '¬∞F';
                                }
                            }
                        });
                })
                .catch(error => console.error('Error:', error));
        }
        
        function updateStatistics() {
            fetch('/api/sensors/history?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        // Calculate statistics
                        const temps = data.map(d => d.temperature);
                        const humidities = data.map(d => d.humidity);
                        
                        const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length * 9/5 + 32).toFixed(0);
                        const minTemp = (Math.min(...temps) * 9/5 + 32).toFixed(0);
                        const maxTemp = (Math.max(...temps) * 9/5 + 32).toFixed(0);
                        const avgHumidity = (humidities.reduce((a, b) => a + b, 0) / humidities.length).toFixed(0);
                        const minHumidity = Math.min(...humidities).toFixed(0);
                        const maxHumidity = Math.max(...humidities).toFixed(0);
                        
                        // Update stat boxes
                        const statBoxes = document.querySelectorAll('.stat-box .stat-value');
                        if (statBoxes.length >= 6) {
                            statBoxes[0].textContent = avgTemp + '¬∞';
                            statBoxes[1].textContent = minTemp + '¬∞';
                            statBoxes[2].textContent = maxTemp + '¬∞';
                            statBoxes[3].textContent = avgHumidity + '%';
                            statBoxes[4].textContent = minHumidity + '%';
                            statBoxes[5].textContent = maxHumidity + '%';
                        }
                    }
                })
                .catch(error => console.error('Stats error:', error));
        }
        
        function updateChart() {
            fetch('/api/sensors/history?hours=48')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const canvas = document.getElementById('historyChart');
                        if (canvas && typeof Chart !== 'undefined') {
                            const ctx = canvas.getContext('2d');
                            
                            // Prepare data
                            const labels = data.map(d => {
                                const date = new Date(d.timestamp * 1000);
                                return date.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
                            });
                            const temps = data.map(d => d.temperature * 9/5 + 32);
                            const humidities = data.map(d => d.humidity);
                            
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Temperature (¬∞F)',
                                        data: temps,
                                        borderColor: 'rgb(237, 125, 49)',
                                        backgroundColor: 'rgba(237, 125, 49, 0.1)',
                                        yAxisID: 'y',
                                    }, {
                                        label: 'Humidity (%)',
                                        data: humidities,
                                        borderColor: 'rgb(91, 155, 213)',
                                        backgroundColor: 'rgba(91, 155, 213, 0.1)',
                                        yAxisID: 'y1',
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    interaction: {
                                        mode: 'index',
                                        intersect: false,
                                    },
                                    scales: {
                                        y: {
                                            type: 'linear',
                                            display: true,
                                            position: 'left',
                                            title: {
                                                display: true,
                                                text: 'Temperature (¬∞F)'
                                            }
                                        },
                                        y1: {
                                            type: 'linear',
                                            display: true,
                                            position: 'right',
                                            title: {
                                                display: true,
                                                text: 'Humidity (%)'
                                            },
                                            grid: {
                                                drawOnChartArea: false,
                                            },
                                        },
                                    }
                                }
                            });
                        }
                    }
                })
                .catch(error => console.error('Chart error:', error));
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            updateData();
            updateStatistics();
            updateChart();
            loadPlants();
            // Update every 5 seconds
            setInterval(updateData, 5000);
            // Update stats and chart every 2 minutes
            setInterval(updateStatistics, 120000);
            
            // Plant form submission
            document.getElementById('addPlantBtn').addEventListener('click', addPlant);
            document.getElementById('clearPlantBtn').addEventListener('click', clearPlantForm);
        });
        
        function loadPlants() {
            console.log('Loading plants...');
            fetch('/api/plants')
                .then(response => response.json())
                .then(plants => {
                    console.log('Plants loaded:', plants);
                    const plantList = document.getElementById('plantList');
                    if (!plantList) {
                        console.error('plantList element not found!');
                        return;
                    }
                    if (plants && plants.length > 0) {
                        plantList.innerHTML = plants.map(plant => `
                            <div class="plant-item">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${plant.strain_name}</strong> (${plant.plant_type})
                                        ${plant.veg_start_date ? `<br>Veg: ${plant.veg_start_date}` : ''}
                                        ${plant.flower_start_date ? ` | Flower: ${plant.flower_start_date}` : ''}
                                        ${plant.dry_weight ? `<br>Yield: ${plant.dry_weight} lbs` : ''}
                                        ${plant.notes ? `<br><small>${plant.notes}</small>` : ''}
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="window.deletePlant(${plant.id})">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        plantList.innerHTML = '<p>No plants added yet</p>';
                    }
                })
                .catch(error => console.error('Error loading plants:', error));
        }
        
        function addPlant() {
            const data = {
                strain_name: document.getElementById('strainName').value,
                plant_type: document.getElementById('plantType').value,
                veg_start_date: document.getElementById('vegStartDate').value,
                flower_start_date: document.getElementById('flowerStartDate').value,
                harvest_date: document.getElementById('harvestDate').value,
                dry_weight: parseFloat(document.getElementById('dryWeight').value) || null,
                notes: document.getElementById('plantNotes').value
            };
            
            if (!data.strain_name || !data.plant_type) {
                alert('Please enter strain name and type');
                return;
            }
            
            fetch('/api/plants', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Plant added successfully!');
                    clearPlantForm();
                    loadPlants();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding plant');
            });
        }
        
        function clearPlantForm() {
            document.getElementById('strainName').value = '';
            document.getElementById('plantType').value = '';
            document.getElementById('vegStartDate').value = '';
            document.getElementById('flowerStartDate').value = '';
            document.getElementById('harvestDate').value = '';
            document.getElementById('dryWeight').value = '';
            document.getElementById('plantNotes').value = '';
        }
        
        function deletePlant(plantId) {
            console.log('deletePlant called with ID:', plantId);
            if (!confirm('Are you sure you want to delete this plant?')) {
                return;
            }
            
            console.log('Sending archive request for plant:', plantId);
            fetch(`/api/plants/${plantId}/archive`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                console.log('Archive result:', result);
                if (result.success) {
                    loadPlants();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting plant');
            });
        }
        
        // Make deletePlant globally accessible
        window.deletePlant = deletePlant;
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå± Greenhouse Monitor</h1>
            <div class="subtitle">Real-time environmental monitoring</div>
        </header>

        <!-- Temperature and Humidity Cards -->
        <section class="readings-grid">
            <div class="card reading-card">
                <div class="card-header">
                    <h2>üå°Ô∏è Temperature</h2>
                </div>
                <div class="card-body">
                    <div class="large-value">
                        <span id="tempValue">--</span>
                    </div>
                    <div class="value-unit">FAHRENHEIT</div>
                    <div class="value-secondary" id="tempCelsius">--</div>
                </div>
            </div>

            <div class="card reading-card">
                <div class="card-header">
                    <h2>üíß Humidity</h2>
                </div>
                <div class="card-body">
                    <div class="large-value">
                        <span id="humidityValue">--</span>
                    </div>
                    <div class="value-unit">PERCENT</div>
                    <div class="value-secondary">--</div>
                </div>
            </div>
        </section>

        <!-- Plant Tracker Section -->
        <section class="card">
            <div class="card-header clickable" onclick="toggleSection('plantTracker')">
                <h2>üåø Plant Tracker</h2>
                <span class="expand-icon" id="plantTrackerIcon">‚ñº</span>
            </div>
            <div class="card-body" id="plantTrackerContent">
                <div class="section-header clickable" onclick="toggleSubSection('addPlant')">
                    <div class="section-title">‚ûï Add New Plant</div>
                    <span class="expand-icon" id="addPlantIcon">‚ñº</span>
                </div>
                <div class="sub-section" id="addPlantContent">
                    <div class="form-group">
                        <label>Strain Name *</label>
                        <input type="text" id="strainName" class="form-input" placeholder="e.g., Blue Dream">
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="plantType" class="form-input">
                            <option value="">-- Select Type --</option>
                            <option value="Indica">Indica</option>
                            <option value="Sativa">Sativa</option>
                            <option value="Hybrid">Hybrid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Veg Start Date</label>
                        <input type="date" id="vegStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Flower Start Date</label>
                        <input type="date" id="flowerStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Harvest Date</label>
                        <input type="date" id="harvestDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Dry Weight (lbs)</label>
                        <input type="number" id="dryWeight" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="plantNotes" class="form-input" rows="3" placeholder="Add any notes about this plant..."></textarea>
                    </div>
                    <div class="button-group">
                        <button id="addPlantBtn" class="btn btn-primary">Add Plant</button>
                        <button id="clearPlantBtn" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
                
                <!-- Plant List -->
                <div style="margin-top: 20px;">
                    <h3>Your Plants</h3>
                    <div id="plantList"></div>
                </div>
            </div>
        </section>

        <!-- System Status Section -->
        <section class="card">
            <div class="card-header">
                <h2>‚öôÔ∏è System Status</h2>
            </div>
            <div class="card-body">
                <div class="relay-list">
                    <div class="relay-item">
                        <span>Humidifier</span>
                    </div>
                    <div class="relay-item">
                        <span>Dehumidifier</span>
                    </div>
                    <div class="relay-item">
                        <span>Heater</span>
                    </div>
                    <div class="relay-item">
                        <span>Light</span>
                    </div>
                </div>

                <div class="target-settings">
                    <div class="target-row">
                        <span class="target-label">Target Humidity: <strong id="targetHumidityDisplay">--%</strong></span>
                    </div>
                    <div class="target-input-group">
                        <label>New Target:</label>
                        <input type="number" class="inline-input" id="newTargetHumidity" placeholder="">
                        <span>%</span>
                        <button class="btn btn-small btn-primary">Set</button>
                    </div>

                    <div class="target-row" style="margin-top: 20px;">
                        <span class="target-label">Target Temp: <strong id="targetTempDisplay">--¬∞F</strong></span>
                    </div>
                    <div class="target-input-group">
                        <label>New Temp:</label>
                        <input type="number" class="inline-input" id="newTargetTemp" placeholder="">
                        <span>¬∞F</span>
                        <button class="btn btn-small btn-orange">Set</button>
                    </div>
                </div>

                <!-- Light Schedule -->
                <div class="schedule-section">
                    <h3>üí° Light Schedule</h3>
                    <div class="schedule-inputs">
                        <div class="schedule-row">
                            <label>On:</label>
                            <input type="number" class="time-input" placeholder="">
                            <span>hours</span>
                        </div>
                        <div class="schedule-row">
                            <label>Off:</label>
                            <input type="number" class="time-input" placeholder="">
                            <span>hours</span>
                        </div>
                        <div class="schedule-row">
                            <label>Off at:</label>
                            <input type="time" class="time-input" placeholder="">
                        </div>
                        <button class="btn btn-yellow">Set Schedule</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Soil Moisture & Watering -->
        <section class="card">
            <div class="card-header">
                <h2>üåßÔ∏è Soil Moisture & Watering</h2>
                <button class="btn btn-refresh" onclick="refreshSoil()">Refresh</button>
            </div>
            <div class="card-body">
                <div id="soilLoading">Loading moisture sensors...</div>
                <h3>Moisture History (All Sensors)</h3>
                <div class="chart-container" id="soilChartContainer"></div>
                
                <!-- Watering Controls -->
                <div class="section-header clickable" onclick="toggleSubSection('wateringControls')">
                    <div class="section-title">Watering Controls</div>
                    <span class="expand-icon" id="wateringControlsIcon">‚ñº</span>
                </div>
                <div class="sub-section collapsed" id="wateringControlsContent">
                    <h4>Set Threshold</h4>
                    <div class="form-group">
                        <label>Sensor</label>
                        <select class="form-input">
                            <option>Sensor 1</option>
                            <option>Sensor 2</option>
                            <option>Sensor 3</option>
                            <option>Sensor 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Min Moisture</label>
                        <input type="number" class="form-input" placeholder="e.g., 30">
                    </div>
                    <div class="form-group">
                        <label>Link to Plant</label>
                        <select class="form-input">
                            <option>Select plant...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary">Save Target</button>

                    <h4 style="margin-top: 30px;">Manual Watering</h4>
                    <div class="form-group">
                        <label>Sensor</label>
                        <select class="form-input">
                            <option>Sensor 1</option>
                            <option>Sensor 2</option>
                            <option>Sensor 3</option>
                            <option>Sensor 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (sec)</label>
                        <input type="number" class="form-input" placeholder="e.g., 10">
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <input type="text" class="form-input" placeholder="Optional details">
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary">Trigger</button>
                        <button class="btn btn-primary">Recommend Time</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Flow Meters -->
        <section class="card">
            <div class="card-header">
                <h2>üö∞ Flow Meters</h2>
            </div>
            <div class="card-body">
                <div>Loading meters...</div>
            </div>
        </section>

        <!-- Historical Data -->
        <section class="card">
            <div class="card-header">
                <h2>üìà Historical Data (48h)</h2>
            </div>
            <div class="card-body chart-body">
                <canvas id="historyChart"></canvas>
            </div>
        </section>

        <!-- 24h Statistics -->
        <section class="card">
            <div class="card-header">
                <h2>üìä 24h Statistics</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Avg Temp (¬∞F)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Min Temp (¬∞F)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Max Temp (¬∞F)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Avg Humidity</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Min Humidity</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Max Humidity</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Camera -->
        <section class="card">
            <div class="card-header">
                <h2>üì∑ Live Camera</h2>
            </div>
            <div class="card-body">
                <div class="camera-placeholder">
                    <p>Stream unavailable</p>
                    <div class="camera-icon">‚ñ∂Ô∏è</div>
                </div>
            </div>
        </section>
    </div>

    <script src="/static/js/dashboard.js?v=2"></script>
    <script>
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function toggleSubSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = '‚ñ≤';
            } else {
                content.classList.add('collapsed');
                icon.textContent = '‚ñº';
            }
        }

        function refreshSoil() {
            document.getElementById('soilLoading').textContent = 'Refreshing...';
            setTimeout(() => {
                document.getElementById('soilLoading').textContent = 'Loading moisture sensors...';
            }, 1000);
        }
    </script>
</body>
</html>
